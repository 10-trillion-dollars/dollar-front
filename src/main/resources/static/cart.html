<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>장바구니</title>
</head>
<body>
<h2>장바구니</h2>
<div id="cartItems"></div>
<p id="totalPrice">총 가격: 0원</p>
<button id="placeOrderBtn">주문하기</button> <!-- 주문하기 버튼 -->


<script>
  document.addEventListener('DOMContentLoaded', function() {
    displayCartItems();

    document.getElementById('placeOrderBtn').addEventListener('click', function() {
      if (checkTokenExists()) {
        placeOrder();
      } else {
        alert('로그인이 필요한 기능입니다.');
        window.location.href = 'signupin.html';
      }
    });
  });


  function displayCartItems() {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    let total = 0;
    const cartItemsContainer = document.getElementById('cartItems');
    cartItemsContainer.innerHTML = '';

    cartItems.forEach((item, index) => {
      const itemElement = document.createElement('div');
      itemElement.innerHTML = `
      <img src="${item.photo}" alt="${item.name}" style="width: 100px; height: auto;">
      <p>${item.name}</p>
      <p>가격: ${item.price}원</p>
      <p>수량: <span class="quantity" data-index="${index}">${item.quantity}</span></p>
      <button onclick="updateQuantity(${index}, -1)">-</button>
      <button onclick="updateQuantity(${index}, 1)">+</button>
      <p>합계: <span class="total">${item.price * item.quantity}</span>원</p>
    `;
      cartItemsContainer.appendChild(itemElement);

      total += item.price * item.quantity;
    });

    document.getElementById('totalPrice').textContent = `총 가격: ${total}원`;
  }

  // function checkLoginStatus() {
  //   return fetch('/api/check-login', {
  //     method: 'GET',
  //     credentials: 'include' // 쿠키를 포함시키기 위해 필요
  //   })
  //   .then(response => {
  //     if (!response.ok) {
  //       throw new Error('로그인 상태 확인 실패');
  //     }
  //     return response.json();
  //   })
  //   .then(data => {
  //     return data.isLoggedIn; // 로그인 상태 반환 (예시: { isLoggedIn: true })
  //   })
  //   .catch(error => {
  //     console.error('Error:', error);
  //     return false;
  //   });
  // }

  function checkTokenExists() {
    const cookies = document.cookie.split(';');
    return cookies.some(cookie => cookie.trim().startsWith('Authorization='));
  }

  function placeOrder() {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    // 장바구니 아이템을 basket 형태로 변환
    let basket = {};
    cartItems.forEach(item => {
      basket[item.productId] = item.quantity;
    });

    // 서버에 전송할 요청 본문 구성
    const orderRequest = {
      basket: basket,
      addressId: 1 // 주소 ID는 1로 고정
    };

    // 서버에 주문 요청을 보내는 fetch API 호출
    fetch('http://localhost:8080/order', {
      method: 'POST',
      credentials: 'include', // 쿠키 포함
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderRequest) // 요청 본문에 주문 정보 포함
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('주문 처리 실패');
      }
      return response.json();
    })
    .then(data => {
      alert('주문이 완료되었습니다.');
      // 주문 완료 후 로컬 스토리지에서 장바구니 정보 삭제
      localStorage.removeItem('cart');
      // 주문 완료 페이지나 메인 페이지로 리다이렉션
      window.location.href = 'orderComplete.html'; // 이 부분은 적절한 주문 완료 페이지로 변경해주세요.
    })
    .catch(error => {
      console.error('Order error:', error);
      alert('주문 처리 중 오류가 발생했습니다.');
    });
  }


  function updateQuantity(index, change) {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    if (index >= 0 && index < cartItems.length) {
      // 수량 변경
      cartItems[index].quantity += change;

      // 수량이 1 미만이 되면 해당 상품 삭제
      if (cartItems[index].quantity < 1) {
        cartItems.splice(index, 1);
      }

      // 변경된 장바구니 정보를 로컬 스토리지에 저장
      localStorage.setItem('cart', JSON.stringify(cartItems));

      // 장바구니 UI를 업데이트
      displayCartItems();
    }
  }


</script>
</body>
</html>
