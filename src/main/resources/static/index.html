<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>쇼핑몰 메인 페이지</title>
</head>
<body>
<input type="text" id="searchBox" placeholder="상품 검색...">
<button id="searchBtn">검색</button>
<button id="basket">장바구니</button>
<button id="loginSignupBtn">로그인/회원가입</button>

<div id="productList">상품 목록이 여기에 표시됩니다.</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginSignupBtn').addEventListener('click', function() {
      window.location.href = 'user.html';
    });

    fetchProducts();

    document.getElementById('searchBtn').addEventListener('click', function() {
      const searchQuery = document.getElementById('searchBox').value;
      fetchSearchProducts(searchQuery);
    });

    document.getElementById('basket').addEventListener('click', function() {
      window.location.href = 'cart.html'; // 장바구니 페이지로 이동
    });

  });

  function fetchProducts() {
    fetch('http://localhost:8083/products')
    .then(response => response.json())
    .then(products => displayProducts(products))
    .catch(error => console.error('Error:', error));
  }

  function fetchSearchProducts(query) {
    fetch(`http://localhost:8083/products/search?search=${query}`)
    .then(response => response.json())
    .then(products => displayProducts(products))
    .catch(error => console.error('Error:', error));
  }

  function displayProducts(products) {
    const productList = document.getElementById('productList');
    productList.innerHTML = '';

    products.forEach(product => {
      const productElement = document.createElement('div');
      productElement.innerHTML = `
            <div>
                <img src="${product.photo}" alt="${product.name}" style="cursor:pointer;width:100px;height:auto;" onclick="window.location.href = 'productDetail.html?productId=${product.id}'">
                <h3>${product.name}</h3>
                <p>가격: ${product.price}원</p>
                수량: <input type="number" class="quantity" value="1" min="1" style="width: 50px;">
                <button>장바구니에 담기</button>
            </div>
        `;
      productList.appendChild(productElement);

      // 장바구니에 담기 버튼에 이벤트 리스너 추가
      productElement.querySelector('button').addEventListener('click', () => {
        const quantity = productElement.querySelector('.quantity').value;
        addToCart(product, quantity);
      });
    });
  }

  function addToCart(product, quantity) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const productIndex = cart.findIndex(item => item.productId === product.id);

    if (productIndex !== -1) {
      // 상품이 이미 있으면, 수량만 업데이트
      cart[productIndex].quantity += parseInt(quantity, 10);
    } else {
      // 상품이 장바구니에 없으면, 상품 정보와 함께 추가
      cart.push({
        productId: product.id,
        name: product.name,
        price: product.price,
        quantity: parseInt(quantity, 10),
        photo: product.photo
      });
    }

    // 변경된 장바구니 데이터를 로컬 스토리지에 저장
    localStorage.setItem('cart', JSON.stringify(cart));
    alert('장바구니에 상품이 추가되었습니다!');
  }

</script>
</body>
</html>