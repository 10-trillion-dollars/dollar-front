<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>쇼핑몰 메인 페이지</title>
</head>
<body>
<div id="nav-container"></div>
<!--<button id="adminDashboard">관리자 페이지</button>-->
<div id="productList">상품 목록이 여기에 표시됩니다.</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
     fetchProducts();
   });

  function getTokenFromCookie() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const parts = cookie.split('=');
      const name = parts[0].trim();
      if (name === 'Authorization') {
        return parts[1];
      }
    }
    return null;
  }
  function fetchProducts() {
    fetch('http://localhost:8080/products',{
      method: 'GET'
    })
    .then(response => response.json())
    .then(products => displayProducts(products))
    .catch(error => console.error('Error:', error));
  }

  function fetchProductImage(productId) {
    // S3에서 이미지를 가져오는 요청을 보냅니다.
    return fetch(`http://localhost:8080/` + productId)
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to fetch product image');
      }
      return response.blob();
    })
    .then(blob => URL.createObjectURL(blob))
    .catch(error => {
      console.error('Error fetching product image:', error);
      return null;
    });
  }


  function displayProducts(products) {
    const productList = document.getElementById('productList');
    productList.innerHTML = '';

    products.forEach(product => {
      const productElement = document.createElement('div');
      productElement.innerHTML = `
            <div>
                <img src="${product.imageUrl}" alt="${product.name}" style="cursor:pointer;width:100px;height:auto;" onclick="window.location.href = 'productDetail.html?productId=${product.id}'">
                <h3>${product.name}</h3>
                <p>가격: ${product.price}원</p>
                수량: <input type="number" class="quantity" value="1" min="1" style="width: 50px;">
                <button>장바구니에 담기</button>
            </div>
        `;
      productList.appendChild(productElement);

      // 장바구니에 담기 버튼에 이벤트 리스너 추가
      productElement.querySelector('button').addEventListener('click', () => {
        const quantity = productElement.querySelector('.quantity').value;
        addToCart(product, quantity);
      });
    });
  }

  function addToCart(product, quantity) {
    let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
    const productIndex = cart.findIndex(item => item.productId === product.id);

    if (productIndex !== -1) {
      // 상품이 이미 있으면, 수량만 업데이트
      cart[productIndex].quantity += parseInt(quantity, 10);
    } else {
      // 상품이 장바구니에 없으면, 상품 정보와 함께 추가
      cart.push({
        productId: product.id,
        name: product.name,
        price: product.price,
        quantity: parseInt(quantity, 10),
        photo: product.photo
      });
    }

    // 변경된 장바구니 데이터를 로컬 스토리지에 저장
    sessionStorage.setItem('cart', JSON.stringify(cart));
    alert('장바구니에 상품이 추가되었습니다!');
  }

</script>
<script src="/js/common.js"></script>
</body>
</html>
