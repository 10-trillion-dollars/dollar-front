<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>쇼핑몰 메인 페이지</title>
</head>
<body>
<form th:action="@{/}" method="get">
  <input type="text" id="searchBox" name="search" placeholder="상품 검색..." th:value="${search}">
  <button type="submit" id="searchBtn">검색</button>
</form>
<button id="basket" th:onclick="'window.location.href = \'' + @{/cart} + '\''">장바구니</button>
<a th:if="${!isAuthenticated}" th:href="@{/loginSignup}" class="btn btn-primary">로그인/회원가입</a>
<a th:if="${isAuthenticated}" th:href="@{/logout}" class="btn btn-primary">로그아웃</a>

<div id="productList">
  <div th:each="product : ${products}">
    <div class="product-info"
         th:data-product-id="${product.id}"
         th:data-product-name="${product.name}"
         th:data-product-price="${product.price}"
         th:data-product-photo="${product.photo}">
      <a th:href="@{/products/{id}(id=${product.id})}">
        <img th:src="@{${product.photo}}" alt="Product Image" style="width:100px;height:auto;">
      </a>
      <h3 th:text="${product.name}">Product Name</h3>
      <p th:text="${'가격: ' + product.price + '원'}">Price</p>
      수량: <input type="number" class="quantity" value="1" min="1" style="width: 50px;">
      <button class="addToCart">장바구니에 담기</button>
    </div>
  </div>
</div>


<!-- 로그인 상태가 아닐 때 오류 메시지를 표시할 수 있습니다 -->
<div th:if="${!isAuthenticated}">
  <p>로그인이 필요합니다.</p>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.addToCart').forEach(button => {
      button.addEventListener('click', function() {
        const productElement = button.closest('.product-info');

        // `data-` 속성에서 상품 정보를 가져옵니다.
        const productId = productElement.dataset.productId;
        const productName = productElement.dataset.productName;
        const productPrice = productElement.dataset.productPrice;
        const productPhoto = productElement.dataset.productPhoto;

        // 수량 입력 필드에서 값을 가져옵니다.
        const quantityInput = productElement.querySelector('.quantity');
        const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 1;

        // 로컬 스토리지에 상품 정보와 수량을 저장하는 함수를 호출합니다.
        addToCart(productId, productName, productPrice, productPhoto, quantity);
      });
    });
  });

  function addToCart(productId, productName, productPrice, productPhoto, quantity) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const productIndex = cart.findIndex(item => item.productId === productId);

    if (productIndex !== -1) {
      // 상품이 이미 장바구니에 있으면, 입력된 수량을 추가합니다.
      cart[productIndex].quantity += quantity;
    } else {
      // 상품이 장바구니에 없으면, 상품 정보와 함께 추가합니다.
      cart.push({
        productId: productId,
        productName: productName,
        productPrice: productPrice,
        productPhoto: productPhoto,
        quantity: quantity
      });
    }

    // 변경된 장바구니 데이터를 로컬 스토리지에 저장합니다.
    localStorage.setItem('cart', JSON.stringify(cart));
    alert('장바구니에 상품이 추가되었습니다!');
  }

</script>

</body>
</html>
